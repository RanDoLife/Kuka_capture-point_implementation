<?xml version="1.0"?>
<robot xmlns:xacro="http://wiki.ros.org/xacro">
  <xacro:include filename="$(find kuka_resources)/urdf/common_materials.xacro"/>

  <xacro:macro name="kuka_kr3r540" params="prefix EE_schunk">
    <link name="${prefix}base_link">
      <visual>
        <origin xyz="0 0 0" rpy="0 0 0" />
        <geometry>
          <mesh filename="package://kuka_kr3_support/meshes/kr3r540/visual/base_link.stl" />
        </geometry>
        <xacro:material_kuka_pedestal />
      </visual>
      <collision>
        <origin xyz="0 0 0" rpy="0 0 0" />
        <geometry>
          <mesh filename="package://kuka_kr3_support/meshes/kr3r540/collision/base_link.stl" />
        </geometry>
      </collision>
    </link>
    <link name="${prefix}link_1">
      <visual>
        <origin xyz="0 0 0" rpy="0 0 0" />
        <geometry>
          <mesh filename="package://kuka_kr3_support/meshes/kr3r540/visual/link_1.stl" />
        </geometry>
        <xacro:material_kuka_ral_pure_white />
      </visual>
      <collision>
        <origin xyz="0 0 0" rpy="0 0 0" />
        <geometry>
          <mesh filename="package://kuka_kr3_support/meshes/kr3r540/collision/link_1.stl" />
        </geometry>
      </collision>
    </link>
    <link name="${prefix}link_2">
      <visual>
        <origin xyz="0 0 0" rpy="0 0 0" />
        <geometry>
          <mesh filename="package://kuka_kr3_support/meshes/kr3r540/visual/link_2.stl" />
        </geometry>
        <xacro:material_kuka_ral_pure_white />
      </visual>
      <collision>
        <origin xyz="0 0 0" rpy="0 0 0" />
        <geometry>
          <mesh filename="package://kuka_kr3_support/meshes/kr3r540/collision/link_2.stl" />
        </geometry>
      </collision>
    </link>
    <link name="${prefix}link_3">
      <visual>
        <origin xyz="0 0 0" rpy="0 0 0" />
        <geometry>
          <mesh filename="package://kuka_kr3_support/meshes/kr3r540/visual/link_3.stl" />
        </geometry>
        <xacro:material_kuka_ral_pure_white />
      </visual>
      <collision>
        <origin xyz="0 0 0" rpy="0 0 0" />
        <geometry>
          <mesh filename="package://kuka_kr3_support/meshes/kr3r540/collision/link_3.stl" />
        </geometry>
      </collision>
    </link>
    <link name="${prefix}link_4">
      <visual>
        <origin xyz="0 0 0" rpy="0 0 0" />
        <geometry>
          <mesh filename="package://kuka_kr3_support/meshes/kr3r540/visual/link_4.stl" />
        </geometry>
        <xacro:material_kuka_ral_pure_white />
      </visual>
      <collision>
        <origin xyz="0 0 0" rpy="0 0 0" />
        <geometry>
          <mesh filename="package://kuka_kr3_support/meshes/kr3r540/collision/link_4.stl" />
        </geometry>
      </collision>
    </link>
    <link name="${prefix}link_5">
      <visual>
        <origin xyz="0 0 0" rpy="0 0 0" />
        <geometry>
          <mesh filename="package://kuka_kr3_support/meshes/kr3r540/visual/link_5.stl" />
        </geometry>
        <xacro:material_kuka_ral_pure_white />
      </visual>
      <collision>
        <origin xyz="0 0 0" rpy="0 0 0" />
        <geometry>
          <mesh filename="package://kuka_kr3_support/meshes/kr3r540/collision/link_5.stl" />
        </geometry>
      </collision>
    </link>
    <link name="${prefix}link_6">
      <visual>
        <origin xyz="0 0 0" rpy="0 0 0" />
        <geometry>
          <mesh filename="package://kuka_kr3_support/meshes/kr3r540/visual/link_6.stl" />
        </geometry>
        <xacro:material_kuka_pedestal />
      </visual>
      <collision>
        <origin xyz="0 0 0" rpy="0 0 0" />
        <geometry>
          <mesh filename="package://kuka_kr3_support/meshes/kr3r540/collision/link_6.stl" />
        </geometry>
      </collision>
    </link>

    <!-- Following REP199, this frame shall be use to attach EEF or other equipment -->
    <link name="${prefix}flange" />

    <joint name="${prefix}joint_a1" type="revolute">
      <origin xyz="0 0 0.345" rpy="0 0 0"/>
      <parent link="${prefix}base_link"/>
      <child link="${prefix}link_1"/>
      <axis xyz="0 0 -1"/>
      <limit lower="${radians(-170)}" upper="${radians(170)}" effort="0" velocity="${radians(530)}"/>
    </joint>
    <joint name="${prefix}joint_a2" type="revolute">
      <origin xyz="0.020 0 0" rpy="0 0 0"/>
      <parent link="${prefix}link_1"/>
      <child link="${prefix}link_2"/>
      <axis xyz="0 1 0"/>
      <limit lower="${radians(-170)}" upper="${radians(50)}" effort="0" velocity="${radians(529)}"/>
    </joint>
    <joint name="${prefix}joint_a3" type="revolute">
      <origin xyz="0.260 0 0" rpy="0 0 0"/>
      <parent link="${prefix}link_2"/>
      <child link="${prefix}link_3"/>
      <axis xyz="0 1 0"/>
      <limit lower="${radians(-110)}" upper="${radians(155)}" effort="0" velocity="${radians(538)}"/>
    </joint>
    <joint name="${prefix}joint_a4" type="revolute">
      <origin xyz="0 0 0.020" rpy="0 0 0"/>
      <parent link="${prefix}link_3"/>
      <child link="${prefix}link_4"/>
      <axis xyz="-1 0 0"/>
      <limit lower="${radians(-175)}" upper="${radians(175)}" effort="0" velocity="${radians(600)}"/>
    </joint>
    <joint name="${prefix}joint_a5" type="revolute">
      <origin xyz="0.260 0 0" rpy="0 0 0"/>
      <parent link="${prefix}link_4"/>
      <child link="${prefix}link_5"/>
      <axis xyz="0 1 0"/>
      <limit lower="${radians(-120)}" upper="${radians(120)}" effort="0" velocity="${radians(600)}"/>
    </joint>
    <joint name="${prefix}joint_a6" type="revolute">
      <origin xyz="0.075 0 0" rpy="0 0 0"/>
      <parent link="${prefix}link_5"/>
      <child link="${prefix}link_6"/>
      <axis xyz="-1 0 0"/>
      <limit lower="${radians(-350)}" upper="${radians(350)}" effort="0" velocity="${radians(800)}"/>
    </joint>
    <joint name="${prefix}joint_a6-tool0" type="fixed">
      <parent link="${prefix}link_6"/>
      <child link="${prefix}flange"/>
      <origin xyz="0 0 0" rpy="0 0 0"/>
    </joint>

    <!-- ROS base_link to KUKA $ROBROOT coordinate system transform -->
    <link name="${prefix}base" />
    <joint name="${prefix}base_link-base" type="fixed">
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <parent link="${prefix}base_link"/>
      <child link="${prefix}base"/>
    </joint>

    <!-- This frame corresponds to the $TOOL coordinate system in KUKA KRC controllers -->
    <link name="${prefix}tool0" />
    <joint name="${prefix}flange-tool0" type="fixed">
      <parent link="${prefix}flange"/>
      <child link="${prefix}tool0"/>
      <origin xyz="0 0 0" rpy="0 ${radians(90)} 0"/>
    </joint>


    <!-- =================================== -->
    <!-- ========== END-EFFECTORS ========== -->

    <!-- === SCHUNK EGP-64 GRIPPER === -->
    <xacro:if value="${EE_schunk}">

      <!-- Schunk coupler (LINK): -->
      <link name="schunk_coupler">
        <visual>
          <geometry>
            <mesh filename="file://$(find kuka_kr3_support)/meshes/egp64/Schunk Gripper - ADAPTER.dae" />
          </geometry>
        </visual>
        <collision>
          <geometry>
            <mesh filename="file://$(find kuka_kr3_support)/meshes/egp64/Schunk Gripper - ADAPTER.dae" />
          </geometry>
        </collision>
        <inertial>
          <origin xyz="0 0 0" rpy="0 0 ${pi/4}" />
          <mass value="0.001" />
          <inertia ixx="0.001" ixy="0.0" ixz="0.0" iyy="0.001" iyz="0.0" izz="0.001"/>
        </inertial>
      </link>

      <!-- Schunk coupler (JOINT): -->
      <joint name="schunk_coupler_joint" type="fixed">
        <origin xyz="0 0 0.001" rpy="0 0 0" />
        <parent link="${prefix}tool0"/>
        <child link="schunk_coupler"/>
      </joint>
      <gazebo reference="schunk_coupler">
        <mu1>0.9</mu1>
        <mu2>0.9</mu2>
        <material>Gazebo/Black</material>
      </gazebo> 

      <link name="egp64_gripper_base_link">
        <inertial>
          <origin xyz="0 0 0" rpy="0 0 0" />
          <mass value="0.005" />
          <inertia ixx="0.001" ixy="0.0" ixz="0.0" iyy="0.001" iyz="0.0" izz="0.001"/>
        </inertial>
        <visual>
          <geometry>
            <mesh filename="file://$(find kuka_kr3_support)/meshes/egp64/Schunk Gripper - BASE noAdapter.dae" />
          </geometry>
          <material name="blue">
            <color rgba="0 0 1 1"/>
          </material>
        </visual>
        <collision>
          <geometry>
            <mesh filename="file://$(find kuka_kr3_support)/meshes/egp64/Schunk Gripper - BASE noAdapter.dae" />
          </geometry>
          <material name="blue"/>
        </collision>
      </link>

      <joint name="egp64_coupler" type="fixed">
        <parent link="schunk_coupler"/>
        <child link="egp64_gripper_base_link"/>
        <origin xyz="-0.03205 0.01812 0.02047" rpy="0 0 0" />
      </joint>

      <!-- LEFT FINGER BASE -->
      
      <link name="egp64_finger_left_link">
        <inertial>
          <origin xyz="0.01483 -0.00782 0" rpy="0 0 0" />
          <mass value="0.002" />
          <inertia ixx="0.001" ixy="0.0" ixz="0.0" iyy="0.001" iyz="0.0" izz="0.001"/>
        </inertial>
        <visual>
          <geometry>
            <mesh filename="file://$(find kuka_kr3_support)/meshes/egp64/Schunk Gripper - LEFT FINGER BASE.dae" />
          </geometry>
          <material name="black">
            <color rgba="0 0 0 1"/>
          </material>
        </visual>
        <collision>
          <geometry>
            <mesh filename="file://$(find kuka_kr3_support)/meshes/egp64/Schunk Gripper - LEFT FINGER BASE.dae" />
          </geometry>
          <material name="black" />
        </collision>
      </link>
      
      <joint name="egp64_finger_left_joint" type="fixed" >
        <parent link="egp64_gripper_base_link" />
        <child link="egp64_finger_left_link" />
        <!-- <limit effort="100" lower="-0.001" upper="0.04" velocity="0.2"/> -->
        <origin xyz="0.01483 -0.00782 0" rpy="0 0 0" />
        <axis xyz="-1 0 0" />
      </joint>

      <!-- <joint name="egp64_finger_left_joint" type="prismatic" >
        <parent link="egp64_gripper_base_link" />
        <child link="egp64_finger_left_link" />
        <limit effort="100" lower="-0.001" upper="0.04" velocity="0.2"/>
        <origin xyz="0.01483 -0.00782 0" rpy="0 0 0" />
        <axis xyz="-1 0 0" />
      </joint> -->
      
      <!-- LEFT FINGERTIP -->
      
      <link name="egp64_fingertip_left_link">
        <inertial>
          <origin xyz="0.03869 -0.0005 0.00093" rpy="0 0 0" />
          <mass value="0.001" />
          <inertia ixx="0.001" ixy="0.0" ixz="0.0" iyy="0.001" iyz="0.0" izz="0.001"/>
        </inertial>
        <visual>
          <geometry>
            <mesh filename="file://$(find kuka_kr3_support)/meshes/egp64/Schunk Gripper - LEFT FINGER.dae" />
          </geometry>
          <material name="silver">
            <color rgba="0.8 0.8 0.8 1"/>
          </material>
        </visual>
        <collision>
          <geometry>
            <mesh filename="file://$(find kuka_kr3_support)/meshes/egp64/Schunk Gripper - LEFT FINGER.dae" />
          </geometry>
          <material name="black"/>
        </collision>
      </link>
      
      <joint name="egp64_fingertip_left_joint" type="fixed" >
        <parent link="egp64_finger_left_link" />
        <child link="egp64_fingertip_left_link" />
        <origin xyz="0.03869 -0.0005 0.00093" rpy="0 0 0"/>
      </joint>

      
      <!-- RIGHT FINGER BASE -->

      <link name="egp64_finger_right_link">
        <inertial>
          <origin xyz="-0.0153 -0.00602 0" rpy="0 0 0" />
          <mass value="0.002" />
          <inertia ixx="0.001" ixy="0.0" ixz="0.0" iyy="0.001" iyz="0.0" izz="0.001"/>
        </inertial>
        <visual>
          <geometry>
            <mesh filename="file://$(find kuka_kr3_support)/meshes/egp64/Schunk Gripper - RIGHT FINGER BASE.dae" />
          </geometry>
          <material name="black"/>
        </visual>
        <collision>
          <geometry>
            <mesh filename="file://$(find kuka_kr3_support)/meshes/egp64/Schunk Gripper - RIGHT FINGER BASE.dae" />
          </geometry>
          <material name="black"/>
        </collision>
      </link>
      
      <!-- <joint name="egp64_finger_right_joint" type="prismatic" >
        <parent link="egp64_gripper_base_link" />
        <child link="egp64_finger_right_link" />
        <limit effort="100" lower="-0.001" upper="0.04" velocity="0.2"/>
        <origin xyz="-0.0153 -0.00602 0" rpy="0 0 0" />
        <axis xyz="1 0 0" />
      </joint> -->
      <joint name="egp64_finger_right_joint" type="fixed" >
        <parent link="egp64_gripper_base_link" />
        <child link="egp64_finger_right_link" />
        <!-- <limit effort="100" lower="-0.001" upper="0.04" velocity="0.2"/> -->
        <origin xyz="-0.0153 -0.00602 0" rpy="0 0 0" />
        <axis xyz="1 0 0" />
      </joint>
      <!-- RIGHT FINGERTIP -->

      <link name="egp64_fingertip_right_link">
        <inertial>
          <origin xyz="-0.01211 -0.00197 0.00093" rpy="0 0 0" />
          <mass value="0.001" />
          <inertia ixx="0.001" ixy="0.0" ixz="0.0" iyy="0.001" iyz="0.0" izz="0.001"/>
        </inertial>
        <visual>
          <geometry>
            <mesh filename="file://$(find kuka_kr3_support)/meshes/egp64/Schunk Gripper - RIGHT FINGER.dae" />
          </geometry>
          <material name="silver" />
        </visual>
        <collision>
          <geometry>
            <mesh filename="file://$(find kuka_kr3_support)/meshes/egp64/Schunk Gripper - RIGHT FINGER.dae" />
          </geometry>
          <material name="black"/>
      </collision>
      </link>
      
      <joint name="egp64_fingertip_right_joint" type="fixed" >
        <parent link="egp64_finger_right_link" />
        <child link="egp64_fingertip_right_link" />
        <origin xyz="-0.01211 -0.00197 0.00093" rpy="0 0 0"/>
      </joint>

      <!-- SMALL CUBE FOR GRIPPER PLUGIN 

      <link name="EE_egp64">
        <inertial>
          <origin xyz="0 0 0" rpy="0 0 0" />
          <mass value="0.00001" />
          <inertia ixx="0.001" ixy="0.0" ixz="0.0" iyy="0.001" iyz="0.0" izz="0.001"/>
        </inertial>
        <visual>
          <geometry>
            <box size= "0.001 0.001 0.001" />
          </geometry>
        </visual>
      </link>
      
      <joint name="EE_egp64_joint" type="prismatic" >
        <parent link="egp64_gripper_base_link" />
        <child link="EE_egp64" />
        <limit effort="10000" lower="0.0" upper="0.0" velocity="0.0"/>
        <axis xyz="1 0 0" />
        <origin xyz="0.033 -0.018 0.15" rpy="0 0 0"/>
      </joint>-->

    </xacro:if>
    <!-- === SCHUNK EGP-64 GRIPPER === -->

    <!-- === SCHUNK EGP-64 GRIPPER === -->
    <xacro:if value="${EE_schunk}">
      <!-- <transmission name="egp64_left_finger_trans">
        <type>transmission_interface/SimpleTransmission</type>
        <joint name="egp64_finger_left_joint">
          <hardwareInterface>hardware_interface/PositionJointInterface</hardwareInterface>
        </joint>
        <actuator name="egp64_left_finger_motor">
          <mechanicalReduction>1</mechanicalReduction>
        </actuator>
      </transmission>
      <transmission name="egp64_right_finger_trans">
        <type>transmission_interface/SimpleTransmission</type>
        <joint name="egp64_finger_right_joint">
          <hardwareInterface>hardware_interface/PositionJointInterface</hardwareInterface>
        </joint>
        <actuator name="egp64_right_finger_motor">
          <mechanicalReduction>1</mechanicalReduction>
        </actuator>
      </transmission>   -->
    </xacro:if>
    <!-- === SCHUNK EGP-64 GRIPPER === -->
  </xacro:macro>
</robot>
